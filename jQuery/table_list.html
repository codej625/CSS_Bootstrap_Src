<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="/js/kb/auto/chart.js"></script>
<script src="../../../static/vendor/jquery/jquery.min.js" th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script src="../../../static/vendor/jquery-ui/jquery-ui.min.js" th:src="@{/vendor/jquery-ui/jquery-ui.min.js}"></script>
<script src="../../../static/vendor/bootstrap/js/bootstrap.bundle.min.js" th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script src="../../../static/vendor/jquery.easing/jquery.easing.min.js" th:src="@{/vendor/jquery.easing/jquery.easing.min.js}"></script>
<script src="../../../static/vendor/datatables.net/jquery.dataTables.min.js" th:src="@{/vendor/datatables.net/jquery.dataTables.min.js}"></script>
<script src="../../../static/vendor/datatables.net-bs4/js/dataTables.bootstrap4.min.js" th:src="@{/vendor/datatables.net-bs4/js/dataTables.bootstrap4.min.js}"></script>
<script src="../../../static/vendor/moment/moment-with-locales.min.js" th:src="@{/vendor/moment/moment-with-locales.min.js}"></script>
<script src="../../../static/cender/sb-admin-2/js/sb-admin-2.min.js" th:src="@{/cender/sb-admin-2/js/sb-admin-2.min.js}"></script>
<script src="../../../static/js/jquery-calendar-conf.js" th:src="@{/js/jquery-calendar-conf.js}"></script>
<link rel="stylesheet" type="text/css" href="../../../static/vendor/jquery-ui/themes/base/jquery-ui.min.css" th:href="@{/vendor/jquery-ui/themes/base/jquery-ui.min.css}" />
<link rel="stylesheet" type="text/css" href="../../../static/vendor/bootstrap/css/bootstrap.min.css" th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" />
<link rel="stylesheet" href="/css/chart.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<title>chart</title>
</head>
<body>
  <div class="container-fluid">
    <div class="card" id="card-01">
      <div class="card-body">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">MPLANIT</li>
          <li class="breadcrumb-item">CAR</li>
          <li class="breadcrumb-item active" aria-current="page">TRAFFIC MONITORING</li>
        </ol>
        <div class="row">
          <div class="col-8">
            <form id="date-calc-form" action="/kb/auto/list_table.sdo" method="get">
              <div class="date-calc">
                <div class="adv-name">
                
                </div>
                <div>
                  <input type="date" id="dateStart" name="dateStart" value="" /> 
                  <input type="date" id="dateEnd" name="dateEnd" value="" /> 
                  <select name="advertiser">
                    <option value="">SELECT</option>
                    <option value="0">현대해상</option>
                    <option value="1">캐롯</option>
                  </select> 
                  <input class="dateKey" type="hidden" name="setDateKey" value="0" />
                  <input class="btn btn-secondary" type="submit" value="기간설정" />
                  <input class="btn btn-secondary refresh" type="button" onclick="refresh();" value="새로고침" />
                </div>
              </div>
            </form>
            <table class="table table-hover table-bordered text-center">
              <thead>
                <tr class="table-secondary">
                  <th>NO</th>
                  <th>광고주</th>
                  <th>매체사</th>
                  <th>유입 TOTAL</th>
                  <th>전환 TOTAL</th>
                  <th>전환 상세</th>
                </tr>
              </thead>
              <tbody class="tbody-01">

              </tbody>
            </table>
          </div>
          <div class="col-4">
            <div style="border: 1px solid #e9ecef;">
              <canvas id="myChart" style="text-align: center; height: 294px; width: 100%"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card" id="card-02">
      <div class="card-body">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">MPLANIT</li>
          <li class="breadcrumb-item">BLOG</li>
          <li class="breadcrumb-item active" aria-current="page">TRAFFIC MONITORING</li>
        </ol>
        <div class="row">
          <div class="col-8">
            <table class="table table-hover table-bordered text-center">
              <thead>
                <tr class="table-secondary">
                  <th>NO</th>
                  <th>광고주</th>
                  <th>BLOGGER</th>
                  <th>유입 TOTAL</th>
                  <th>전환 TOTAL</th>
                </tr>
              </thead>
              <tbody class="tbody-02">
                
              </tbody>
            </table>
          </div>
          <div class="col-4">
            
          </div>
        </div>
      </div>
    </div>
  </div>
  <script th:inline="javascript">
		/*<![CDATA[*/
		//*전역변수 선언부*======================================================
  		// 모든 매체사의 데이터가 담긴 변수
  		var tableData = /*[[${tableData}]]*/'default';
  		// blog(17) 데이터가 담긴 변수
  		var blogData = /*[[${blogData}]]*/'default';
  		// 'switching'을 하기 위한 변수
  		var switchingKey = /*[[${switchingKey}]]*/'default';
  		// 기간 설정을 하기 위한 변수
  		var setDate = /*[[${setDate}]]*/'default';
  		// date가 변경되었는지 확인 하기 위한 변수
  		var setDateKey = /*[[${setDateKey}]]*/'default';
  		// traffic table을 만들어 담기 위한 변수
  		var trafficTable = '';
  		// blog table을 만들어 담기 위한 변수
  		var blogTable = '';
  		// '현대해상'으로 데이터를 바꾸기 위한 array
  		var hiData = [6, 7, 8, 11, 14];
  		// '캐롯'으로 데이터를 바꾸기 위한 array
  		var carrotData = [9, 10, 12, 13, 16, 17];
  		// board no를 표시하기 위한 변수
  		var number = 1;
  		// calendar의 기본값을 설정하기 date객체와 변수
  		var today = new Date();
  		var day = dateFormat(today);
  		// chart 이름과 값을 변경하기 위한 변수
  		var chart = [];
  		var chartName = '';
  		// traffic total을 순서대로 담기 위한 변수
  		var trafficTotal = [];
  	//*조건 선언부*=========================================================
  		// test
			blogList(blogData, '캐롯');
  		// 현대해상 or 캐롯 data switching / function parameter(data, campaign, advertiser)
  		if (switchingKey === 0) {
  			tableList(tableData, hiData, '현대해상');
  			$('.adv-name').text('[ 현대해상 ]');
  			// chart가 만들어질때 필요한 변수
  	 		var chart = ['TDM', 'MPLANIT', 'NBT', 'TNK', 'IVE'];
	  		var chartName = '현대해상 유입률';
  		} else {
  			tableList(tableData, carrotData, '캐롯');
  			$('.adv-name').text('[ 캐롯 ]');
  			var chart = ['NBT', 'TDM', 'TNK', 'IVE', 'MPLANIT', 'BLOG'];
	  		var chartName = '캐롯 유입률';
	  		// canvas태그의 height를 변경한다.
	  		$('#myChart').height(343);
  		}
  		// setDateKey가 0(default)이면 calendar의 시작과 끝을 today로 지정
  		if (setDateKey === 0) {
    		$('#dateStart').val(day);
  			$('#dateEnd').val(day);
  			// back-end에서 사용되는 key => setDateKey이름으로 front-end단으로 보내짐
  			$('.dateKey').val(1);
  		// setDateKey가 1이면 calendar의 시작과 끝을 back-end 서버에서 넘겨온 값으로 대입
  		} else {
    		$('#dateStart').val(setDate['dateStart'].substring(0, 10));
  			$('#dateEnd').val(setDate['dateEnd'].substring(0, 10));
  			// back-end value(0) => front-end value(1) => back-end value(1) => front-end value(1)...
  			$('.dateKey').val(1);
  		}
		//*함수 선언부*=========================================================
  		// table을 만들기 위한 함수
  		function tableList(data, array, advertiser) {
  			data.forEach(function(item, index) {
  				// data에 key값을 array속에 index값과 맞추어 switch문 실행
  				var idx = item['campaign_seq'];
  				// 테이블의 표시를 위해 객체 속 'campaign_seq'라는 key를 찾아 매체사 이름 대입
  				switch (idx) {
  					// 배열을 순서대로 돌리기 때문에 idx에 의해 변경되는 이름을 삼항연산자로 조건수행
  					case array[0]:(idx===6)?item['campaign_seq']='TDM':item['campaign_seq']='NBT';break;
  					case array[1]:(idx===7)?item['campaign_seq']='MPLANIT':item['campaign_seq']='TDM';break;
  					case array[2]:(idx===8)?item['campaign_seq']='NBT':item['campaign_seq']='TNK';break;
  					case array[3]:(idx===11)?item['campaign_seq']='TNK':item['campaign_seq']='IVE';break;
  					case array[4]:(idx===14)?item['campaign_seq']='IVE':item['campaign_seq']='MPLANIT';break;
  					case array[5]:item['campaign_seq']='BLOG';break;
  					default: return false; break;
  				}
  				// table 생성
  				trafficTable += '<tr><td>' + number + '</td>';
  				trafficTable += '<td>' + advertiser + '</td>';
  				trafficTable += '<td>' + item['campaign_seq'] + '</td>';
  				trafficTable += '<td>' + item['COUNT(campaign_seq)'] + '</td>';
  				trafficTable += '<td>' + item['COUNT(adv_result_params)'] + '</td>';
  				trafficTable += '<td></td></tr>';
    			//  chart에 사용할 traffic total을 담은 array
  				trafficTotal.push(item['COUNT(campaign_seq)']);
  				// for문이 반복될때마다 +1씩 증가
  				number++;
  			});
  			// 첫번째(.tbody-01) 테이블에 table 값을 대입
  			$('.tbody-01').html(trafficTable);
  		}
			// test
  		function blogList(data, advertiser) {
					var maxCountArray = [];
  		    for (var value of data) {
  		    	maxCountArray.push(value['COUNT(campaign_seq)'])
  		    }
  		    
  		    var maxNum = Math.max(...maxCountArray);
  		    //======================================================================여기까지 최대값 구하기
				
  			data.forEach(function(item, index) {
  				// table 생성
  				blogTable += '<tr><td>' + number + '</td>';
  				blogTable += '<td>' + advertiser + '</td>';
  				blogTable += '<td>' + item['media_key'] + '</td>';
  				blogTable += '<td>' + item['COUNT(campaign_seq)'] + '</td>';
  				blogTable += '<td>' + item['COUNT(adv_result_params)'] + '</td></tr>';
  				// for문이 반복될때마다 +1씩 증가
  				number++;
  			});
  			// 첫번째(.tbody-02) 테이블에 table 값을 대입
  			$('.tbody-02').html(blogTable);
  		}
  		// date 형식을 만들기 위한 함수
  		function dateFormat(today) {
  			var year = today.getFullYear();
  			var month = ('0' + (today.getMonth() + 1)).slice(-2);
  			var day = ('0' + today.getDate()).slice(-2);
  			var dateString = year + '-' + month + '-' + day;
  			return dateString;
  		}
  		// 새로고침 함수
  		function refresh() {
  			window.location.href = '/kb/auto/list_table.sdo';
  		}
		//*chart 관련 선언부*=====================================================
			const ctx = document.getElementById('myChart').getContext('2d');
  		const myChart = new Chart(ctx, {
  			type: 'bar',
  			data: {
  				labels: chart,
  				datasets: [{
  					label: chartName,
  					data: trafficTotal,
  					backgroundColor: [
  						'rgba(179, 183, 187, 0.2)',
  						'rgba(179, 183, 187, 0.2)',
  						'rgba(179, 183, 187, 0.2)',
  						'rgba(179, 183, 187, 0.2)',
  						'rgba(179, 183, 187, 0.2)'
  					],
  					borderColor: [
  						'rgba(179, 183, 187, 1)',
  						'rgba(179, 183, 187, 1)',
  						'rgba(179, 183, 187, 1)',
  						'rgba(179, 183, 187, 1)',
  						'rgba(179, 183, 187, 1)'
  					],
  					borderWidth: 1
  				}]
  			},
  			options: {
  				responsive: false,
  				scales: {
  					y: {
  						beginAtZero: true
  					}
  				}
  			}
  		});
  	//====================================================================
		/*]]>*/
	</script>
</body>
</html>